<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CanillitaBot - Logs</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .log-container {
            background: #1e1e1e;
            color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Pygments JSON highlighting styles */
        .log-container .highlight {
            background: transparent !important;
            margin: 10px 0;
            padding: 15px;
            border-left: 3px solid #4a90e2;
            border-radius: 4px;
            background: rgba(74, 144, 226, 0.1) !important;
        }
        
        .log-container .highlight pre {
            margin: 0;
            background: transparent;
            color: inherit;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
        }
        
        /* JSON log entry styling */
        .json-log {
            background: rgba(74, 144, 226, 0.1);
            border-left: 3px solid #4a90e2;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            color: #e1e1e1;
        }
        
        /* Text log entry styling */
        .text-log {
            background: rgba(128, 128, 128, 0.1);
            border-left: 3px solid #888;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            color: #e1e1e1;
        }
        
        /* Level-based styling */
        .log-entry-error .highlight,
        .log-entry-error .json-log,
        .log-entry-error .text-log {
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1) !important;
        }
        
        .log-entry-warning .highlight,
        .log-entry-warning .json-log,
        .log-entry-warning .text-log {
            border-left-color: #ffa500;
            background: rgba(255, 165, 0, 0.1) !important;
        }
        
        .log-entry-info .highlight,
        .log-entry-info .json-log,
        .log-entry-info .text-log {
            border-left-color: #4dabf7;
            background: rgba(77, 171, 247, 0.1) !important;
        }
        
        .log-controls {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .log-controls select,
        .log-controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .log-controls button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .log-controls button:hover {
            background: #0056b3;
        }
        
        .log-info {
            background: #f8f9fa;
            padding: 10px 15px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .error-line {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 2px 0;
        }
        
        .warn-line {
            color: #ffa500;
            background: rgba(255, 165, 0, 0.1);
            padding: 2px 0;
        }
        
        .info-line {
            color: #4dabf7;
        }
        
        .navigation {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .navigation a {
            color: #007bff;
            text-decoration: none;
            margin-right: 15px;
            font-weight: 500;
        }
        
        .navigation a:hover {
            text-decoration: underline;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auto-refresh input[type="checkbox"] {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navigation">
            <a href="/">‚Üê Dashboard</a>
            <a href="/logs">Logs</a>
        </nav>
        
        <h1>üìã CanillitaBot - Application Logs</h1>
        
        <div class="log-controls">
            <label>
                <strong>Log Type:</strong>
                <select id="logType">
                    <option value="main">Main Logs</option>
                    <option value="errors">Error Logs</option>
                </select>
            </label>
            
            <label>
                <strong>Lines:</strong>
                <input type="number" id="logLines" value="100" min="10" max="1000" step="10">
            </label>
            
            <button onclick="loadLogs()" id="refreshBtn">üîÑ Refresh</button>
            
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh">
                <label for="autoRefresh">Auto-refresh (10s)</label>
            </div>
            
            <div class="auto-refresh">
                <input type="checkbox" id="formattedView" checked>
                <label for="formattedView">üé® Pretty JSON</label>
            </div>
        </div>
        
        <div class="log-info" id="logInfo" style="display: none;">
            <!-- Log file information will be shown here -->
        </div>
        
        <div class="log-container" id="logContainer">
            <div style="text-align: center; color: #888; padding: 40px;">
                Click "Refresh" to load logs...
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        
        // Load logs when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadLogs();
        });
        
        // Auto-refresh checkbox handler
        document.getElementById('autoRefresh').addEventListener('change', function() {
            if (this.checked) {
                autoRefreshInterval = setInterval(loadLogs, 10000); // 10 seconds
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        });
        
        async function loadLogs() {
            const logType = document.getElementById('logType').value;
            const lines = document.getElementById('logLines').value;
            const formatted = document.getElementById('formattedView').checked;
            const refreshBtn = document.getElementById('refreshBtn');
            const logContainer = document.getElementById('logContainer');
            const logInfo = document.getElementById('logInfo');
            
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'üîÑ Loading...';
            
            try {
                const rawParam = formatted ? '' : '&raw=true';
                const response = await fetch(`/api/logs?type=${logType}&lines=${lines}${rawParam}`);
                const data = await response.json();
                
                if (data.success) {
                    // Show log info
                    logInfo.style.display = 'block';
                    const formatInfo = data.formatted ? '| üé® Formatted' : '| Raw';
                    logInfo.innerHTML = `
                        <strong>File:</strong> ${data.log_file} | 
                        <strong>Showing:</strong> ${data.showing_lines} of ${data.total_lines} lines | 
                        <strong>Last updated:</strong> ${new Date().toLocaleString()} ${formatInfo}
                    `;
                    
                    let processedLogs;
                    
                    if (data.formatted && formatted) {
                        // Handle new formatted logs
                        processedLogs = data.logs.map(logEntry => {
                            const levelClass = `log-entry-${logEntry.level.toLowerCase()}`;
                            return `<div class="log-entry ${levelClass}">${logEntry.formatted}</div>`;
                        }).join('');
                    } else {
                        // Handle legacy raw logs (backwards compatibility)
                        processedLogs = data.logs.map(line => {
                            const cleanLine = typeof line === 'string' ? line.replace(/\n$/, '') : line;
                            
                            // Add color coding based on log level (legacy approach)
                            if (cleanLine.includes(' ERROR ') || cleanLine.includes(' CRITICAL ')) {
                                return `<div class="error-line">${escapeHtml(cleanLine)}</div>`;
                            } else if (cleanLine.includes(' WARNING ') || cleanLine.includes(' WARN ')) {
                                return `<div class="warn-line">${escapeHtml(cleanLine)}</div>`;
                            } else if (cleanLine.includes(' INFO ')) {
                                return `<div class="info-line">${escapeHtml(cleanLine)}</div>`;
                            } else {
                                return `<div>${escapeHtml(cleanLine)}</div>`;
                            }
                        }).join('');
                    }
                    
                    logContainer.innerHTML = processedLogs || '<div style="text-align: center; color: #888; padding: 40px;">No logs found</div>';
                    
                    // Auto-scroll to bottom
                    logContainer.scrollTop = logContainer.scrollHeight;
                    
                } else {
                    logContainer.innerHTML = `<div style="color: #ff6b6b; text-align: center; padding: 40px;">Error loading logs: ${data.error}</div>`;
                    logInfo.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading logs:', error);
                logContainer.innerHTML = `<div style="color: #ff6b6b; text-align: center; padding: 40px;">Failed to load logs: ${error.message}</div>`;
                logInfo.style.display = 'none';
            }
            
            refreshBtn.disabled = false;
            refreshBtn.textContent = 'üîÑ Refresh';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
